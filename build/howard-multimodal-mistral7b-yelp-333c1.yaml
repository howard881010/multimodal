apiVersion: batch/v1
kind: Job
metadata:
  labels:
    project: multimodal
    user: howard
  name: howard-multimodal-mistral7b-yelp-333c1
  namespace: spatiotemporal-decision-making
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        project: multimodal
        user: howard
      namespace: spatiotemporal-decision-making
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values:
                - hcc-chase-shor-c4719.unl.edu
              - key: nvidia.com/gpu.product
                operator: In
                values:
                - NVIDIA-GeForce-RTX-3090
                - NVIDIA-A10
      containers:
      - command:
        - conda
        - run
        - -n
        - multimodal
        - /bin/bash
        - -c
        - 'echo IyEvYmluL2Jhc2gKbWtkaXIgLXAgY29uZmlnCnNzaC1rZXlzY2FuIGdpdGh1Yi5jb20gPj4gL3Jvb3QvLnNzaC9rbm93bl9ob3N0cwpzc2gta2V5c2NhbiAtdCBlY2RzYSAtcCAzMDYyMiAtSCBnaXRsYWItc3NoLm5ycC1uYXV0aWx1cy5pbyA+PiAvcm9vdC8uc3NoL2tub3duX2hvc3RzCmdpdCBwdWxsCmdpdCBzdWJtb2R1bGUgdXBkYXRlIC0taW5pdCAtLXJlY3Vyc2l2ZQplY2hvICJjb25kYSBhY3RpdmF0ZSBtdWx0aW1vZGFsOyBzb3VyY2Ugc3JjL3Rvb2xib3gvczNyZWdpb24uc2giID4+IH4vLmJhc2hyYwpleHBvcnQgUEFUSD0iL29wdC9jb25kYS9lbnZzL211bHRpbW9kYWwvYmluLzokUEFUSCIKY2htb2QgK3ggc3JjL3Rvb2xib3gvczNyZWdpb24uc2gKc291cmNlIHNyYy90b29sYm94L3MzcmVnaW9uLnNoCmVjaG8gJ0l5QlRNMTlDVlVOTFJWUmZUa0ZOUlQxdE1tWnZjbVZqWVhOMENpTWdRVmRUWDBGRFEwVlRVMTlMUlZsZlNVUTlSMk5QUW5wek4wUTJPVXBoYTJ0NlFrSklSRzBLSXlCQlYxTmZVMFZEVWtWVVgwRkRRMFZUVTE5TFJWazlRVFJ0ZW0xdFVucElWMkYzV1RsRE9YWTFhVlZOVVZscFYzQkZXV0p1UVZCV1pFZ3hTVkozU0FvaklGTXpYMFZPUkZCUFNVNVVYMVZTVEQxb2RIUndjem92TDNKdmMyVmtZWFJoTG5WamMyUXVaV1IxQ2toR1gxUlBTMFZPUFdobVgyTm9TVk5vVlhOc1RVaFlabTFHVFhoMWJrZFplV1JHZFVWd1JWRjNVV05xUkU0S1YwRk9SRUpmUVZCSlgwdEZXVDFzYjJOaGJDMW1NMk0yWXpBeFltTmhPR0psTURZMVpEUmhORFV4WVRFeE5XWTNNR0l3T1Roa1lqY3pOakEwQ2lNZ1YwRk9SRUpmUVZCSlgwdEZXVDA1TUdSak9HTTBNRGc1WXpJeE16WTRZall4Wmpaa01qQTJPV1F6T0RJeU5HUXlNelkwWTJZM0NrZEpWRjlWVTBWU1RrRk5SVDFvYjNkaGNtUTRPREV3TVRBS1IwbFVYMUJCVTFOWFQxSkVQV2RvY0Y5NVUwNXJOM0pRUzJoRGVHVXdlbTFpZDB4Nk1qQlphWFIxYUdkcVEzazBOVGh3VkZRS1YwRk9SRUpmUWtGVFJWOVZVa3c5YUhSMGNITTZMeTl5YjNObGQyRnVaR0l1ZFdOelpDNWxaSFVLUVZkVFgwRkRRMFZUVTE5TFJWbGZTVVE5T0RRMlRGSTFTRVF6TVRORFRUbE9UVFEyU2pNS1FWZFRYMU5GUTFKRlZGOUJRME5GVTFOZlMwVlpQVXhSVEd4UlIzRmFTRFZ1U1VOS1IxRlZPVUpNVW5aUFRFeHRTWFpOVGtGbmRWSlVaRzVVVlRBS1V6TmZSVTVFVUU5SlRsUmZWVkpNUFdoMGRIQnpPaTh2Y3pNdGQyVnpkQzV1Y25BdGJtRjFkR2xzZFhNdWFXOD0nIHwgYmFzZTY0IC1kIHwgdHIgLWQgJ1xyJyA+ICcuZW52JyAmJiBlY2hvID4+ICcuZW52JyAKZWNobyAnY0hKdmFtVmpkRjl1WVcxbE9pQnRkV3gwYVcxdlpHRnNDbTVoYldWemNHRmpaVG9nYzNCaGRHbHZkR1Z0Y0c5eVlXd3RaR1ZqYVhOcGIyNHRiV0ZyYVc1bkNuVnpaWEk2SUdodmQyRnlaQXB5WldkcGMzUnllVjlvYjNOME9pQm5hWFJzWVdJdGNtVm5hWE4wY25rdWJuSndMVzVoZFhScGJIVnpMbWx2Q25OemFGOW9iM04wT2lCbmFYUnNZV0l0YzNOb0xtNXljQzF1WVhWMGFXeDFjeTVwYndwemMyaGZjRzl5ZERvZ016QTJNaklLWTI5dVpHRmZhRzl0WlRvZ0wyOXdkQzlqYjI1a1lRcHBiV0ZuWlRvZ1oybDBiR0ZpTFhKbFoybHpkSEo1TG01eWNDMXVZWFYwYVd4MWN5NXBieTlvYjNkaGNtUXZiWFZzZEdsdGIyUmhiRHBzWVhSbGMzUUtaM0IxWDNkb2FYUmxiR2x6ZERvS0lDQXRJRTVXU1VSSlFTMUhaVVp2Y21ObExWSlVXQzB6TURrd0NpQWdMU0JPVmtsRVNVRXRRVEV3JyB8IGJhc2U2NCAtZCB8IHRyIC1kICdccicgPiAnY29uZmlnL2t1YmUueWFtbCcgJiYgZWNobyA+PiAnY29uZmlnL2t1YmUueWFtbCcgCmVjaG8gJ2NISnZhbVZqZEY5dVlXMWxPaUJ0ZFd4MGFXMXZaR0ZzQ20xdlpHVnNPZ29nSUcxcGMzUnlZV3czWWpvS0lDQWdJR052YlcxaGJtUTZJRDRLSUNBZ0lDQWdaMmwwSUdOb1pXTnJiM1YwSUM0Z0ppWUtJQ0FnSUNBZ1oybDBJSEIxYkd3Z0ppWUtJQ0FnSUNBZ2NIbDBhRzl1SUMxdElHRjRiMnh2ZEd3dVkyeHBMbkJ5WlhCeWIyTmxjM01nWm1sdVpYUjFibVV2WTJ4cGJXRjBaVjl1ZFcxbGNtbGpZV3d1ZVcxc0lDWW1DaUFnSUNBZ0lHRmpZMlZzWlhKaGRHVWdiR0YxYm1Ob0lDMXRJR0Y0YjJ4dmRHd3VZMnhwTG5SeVlXbHVJR1pwYm1WMGRXNWxMMk5zYVcxaGRHVmZiblZ0WlhKcFkyRnNMbmx0YkNBbUppQUtJQ0FnSUNBZ2N6VmpiV1FnWTNBZ1ptbHVaWFIxYm1VdmIzVjBjSFYwY3k5amJHbHRZWFJsTFc1MWJXVnlhV05oYkMxbWFXNWxkSFZ1WlNCek16b3ZMMjExYkhScGJXOWtZV3hmWm1sdVpWOTBkVzVwYm1jS0lDQWdJR053ZFY5amIzVnVkRG9nT0FvZ0lDQWdaM0IxWDJOdmRXNTBPaUE0Q2lBZ0lDQnRaVzF2Y25rNklETXdDbVJoZEdGelpYUTZDaUFnZVdWc2NEb0tJQ0FnSUdod1lYSmhiVG9LSUNBZ0lDQWdYMlp1T2lCSWIzZGhjbVE0T0RFd01UQXZXV1ZzY0Mxa1lYUmhjMlYwQ2lBZ2JXbHRhV002Q2lBZ0lDQm9jR0Z5WVcwNkNpQWdJQ0FnSUY5bWJqb2diV2x0YVdNdWRIaDBDbkoxYmpvS0lDQnRiMlJsYkRvZ1cyMXBjM1J5WVd3M1lsMEtJQ0JrWVhSaGMyVjBPaUJiZVdWc2NGMEtJeUJtYVd4bE9nb2pJQ0FnTFNBdUwyRjRiMnh2ZEd3dlpYaGhiWEJzWlhNdmJHeGhiV0V0TWk5dGVXTnZibVpwWnk1NWJXd0thRzl6ZEc1aGJXVmZkMmhwZEdWc2FYTjBPZ29nSUMwZ2FHTmpMV05vWVhObExYTm9iM0l0WXpRM01Ua3VkVzVzTG1Wa2RRbz0nIHwgYmFzZTY0IC1kIHwgdHIgLWQgJ1xyJyA+ICdjb25maWcvbGF1bmNoLnlhbWwnICYmIGVjaG8gPj4gJ2NvbmZpZy9sYXVuY2gueWFtbCcgCmVjaG8gJ2NISnZhbVZqZEY5dVlXMWxPaUJ0ZFd4MGFXMXZaR0ZzQ201aGJXVnpjR0ZqWlRvZ2MzQmhkR2x2ZEdWdGNHOXlZV3d0WkdWamFYTnBiMjR0YldGcmFXNW5DblZ6WlhJNklHaHZkMkZ5WkFweVpXZHBjM1J5ZVY5b2IzTjBPaUJuYVhSc1lXSXRjbVZuYVhOMGNua3Vibkp3TFc1aGRYUnBiSFZ6TG1sdkNuTnphRjlvYjNOME9pQm5hWFJzWVdJdGMzTm9MbTV5Y0MxdVlYVjBhV3gxY3k1cGJ3cHpjMmhmY0c5eWREb2dNekEyTWpJS1kyOXVaR0ZmYUc5dFpUb2dMMjl3ZEM5amIyNWtZUXBwYldGblpUb2daMmwwYkdGaUxYSmxaMmx6ZEhKNUxtNXljQzF1WVhWMGFXeDFjeTVwYnk5b2IzZGhjbVF2YlhWc2RHbHRiMlJoYkRwc1lYUmxjM1FLWjNCMVgzZG9hWFJsYkdsemREb0tJQ0F0SUU1V1NVUkpRUzFIWlVadmNtTmxMVkpVV0Mwek1Ea3dDaUFnTFNCT1ZrbEVTVUV0UVRFdycgfCBiYXNlNjQgLWQgfCB0ciAtZCAnXHInID4gJ2NvbmZpZy9rdWJlLnlhbWwnICYmIGVjaG8gPj4gJ2NvbmZpZy9rdWJlLnlhbWwnIA==
          | base64 -d > startup.sh && chmod +x startup.sh && source startup.sh; git
          checkout . && git pull && python -m axolotl.cli.preprocess finetune/climate_numerical.yml
          && accelerate launch -m axolotl.cli.train finetune/climate_numerical.yml
          &&  s5cmd cp finetune/outputs/climate-numerical-finetune s3://multimodal_fine_tuning

          '
        env:
        - name: PYTHONUNBUFFERED
          value: '1'
        - name: PYTHONIOENCODING
          value: UTF-8
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: HF_TOKEN
          value: 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
        - name: WANDB_API_KEY
          value: local-f3c6c01bca8be065d4a451a115f70b098db73604
        - name: GIT_USERNAME
          value: howard881010
        - name: GIT_PASSWORD
          value: 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
        - name: WANDB_BASE_URL
          value: https://rosewandb.ucsd.edu
        - name: AWS_ACCESS_KEY_ID
          value: 846LR5HD313CM9NM46J3
        - name: AWS_SECRET_ACCESS_KEY
          value: LQLlQGqZH5nICJGQU9BLRvOLLmIvMNAguRTdnTU0
        - name: S3_ENDPOINT_URL
          value: http://rook-ceph-rgw-nautiluss3.rook
        - name: PYTHONPATH
          value: src
        image: gitlab-registry.nrp-nautilus.io/howard/multimodal:latest
        name: gpu-container
        resources:
          limits:
            cpu: '9.6'
            memory: 36.0G
            nvidia.com/gpu: '8'
          requests:
            cpu: '8'
            memory: 30G
            nvidia.com/gpu: '8'
        volumeMounts:
        - mountPath: /dev/shm
          name: dshm
      imagePullSecrets:
      - name: multimodal-read-registry
      restartPolicy: Never
      tolerations: []
      volumes:
      - emptyDir:
          medium: Memory
        name: dshm
